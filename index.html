<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analog Algorithm • Solar Calendar in 52 Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', system_ui, sans-serif; background: #0a0a0a; color: #e5e5e5; }
        .title { font-family: 'Playfair Display', serif; letter-spacing: -0.05em; }
    </style>
</head>
<body class="min-h-screen">
    <div class="max-w-3xl mx-auto px-6 py-20">
        <div class="flex justify-between items-center mb-16">
            <div class="flex items-center gap-4">
                <span class="text-5xl">♠ ♥ ♣ ♦</span>
                <div>
                    <h1 class="title text-6xl font-bold tracking-tighter">ANALOG ALGORITHM</h1>
                    <p class="text-amber-400 text-sm tracking-[4px] mt-1">52 CARDS • HELICAL TIME</p>
                </div>
            </div>
            <a href="https://x.com/ModernCardology" target="_blank" class="flex items-center gap-2 text-sm font-medium hover:text-amber-400">
                <i class="fab fa-x-twitter"></i> @ModernCardology
            </a>
        </div>

        <div class="grid md:grid-cols-5 gap-8">
            <div class="md:col-span-2 bg-zinc-950 border border-zinc-800 rounded-3xl p-8">
                <h2 class="text-xl font-medium mb-6">Calculate Your Reading</h2>
                <div class="space-y-6">
                    <div>
                        <label class="text-xs text-zinc-500 block mb-2">BIRTH DATE</label>
                        <input id="birth" type="date" class="w-full bg-transparent border-b border-zinc-700 py-3 text-lg focus:outline-none focus:border-amber-400">
                    </div>
                    <div>
                        <label class="text-xs text-zinc-500 block mb-2">TARGET DATE</label>
                        <input id="target" type="date" class="w-full bg-transparent border-b border-zinc-700 py-3 text-lg focus:outline-none focus:border-amber-400">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="calculate('year')" class="bg-white text-black font-semibold py-4 rounded-2xl hover:bg-amber-400 transition">PERSONAL YEAR</button>
                        <button onclick="calculate('week')" class="bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 font-semibold py-4 rounded-2xl transition">PERSONAL WEEK</button>
                    </div>
                </div>
            </div>

            <div id="result-panel" class="hidden md:col-span-3 bg-zinc-950 border border-zinc-800 rounded-3xl p-8 space-y-8">
                <div class="flex justify-between">
                    <div>
                        <div class="text-xs text-zinc-500">YOUR BIRTH CARD</div>
                        <div id="birth-card" class="text-4xl font-mono"></div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-zinc-500">SPREAD YEAR</div>
                        <div id="spread-year" class="text-5xl font-bold text-amber-400"></div>
                    </div>
                </div>

                <div class="debug bg-1a1a1a p-4 rounded-xl">
                    <div class="text-xs text-amber-400 mb-1">7 EXTRACTED CARDS (Mercury → Neptune)</div>
                    <div id="extracted" class="font-mono text-sm"></div>
                </div>

                <div>
                    <div class="text-xs text-zinc-500">ACTIVE CARD • PLANET / DAY</div>
                    <div id="active-card" class="text-4xl font-mono mt-1"></div>
                    <div id="planet-label" class="text-sm text-amber-400 mt-1"></div>
                </div>

                <div class="bg-zinc-900 rounded-2xl p-5">
                    <div class="text-xs text-zinc-500 mb-2">DOMAIN • ARCHETYPE</div>
                    <div id="realm-archetype" class="text-lg"></div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-sm text-amber-400">YOUR DRAFT READING</span>
                        <button onclick="copyDraft()" class="text-xs px-4 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-xl">COPY</button>
                    </div>
                    <textarea id="draft" rows="11" class="w-full bg-transparent border border-zinc-700 rounded-3xl p-6 text-sm leading-relaxed resize-y focus:outline-none focus:border-amber-400"></textarea>
                </div>

                <button onclick="postToX()" class="w-full bg-black hover:bg-zinc-900 border border-white/20 py-5 rounded-3xl flex items-center justify-center gap-3 font-medium text-lg">
                    <i class="fab fa-x-twitter"></i> POST TO X
                </button>
            </div>
        </div>
    </div>

    <script>
        const YEAR_0 = ['7♥','6♥','5♥','4♥','3♥','2♥','A♥','A♣','K♥','Q♥','J♥','10♥','9♥','8♥',
                        '8♣','7♣','6♣','5♣','4♣','3♣','2♣','2♦','A♦','K♣','Q♣','J♣','10♣','9♣',
                        '9♦','8♦','7♦','6♦','5♦','4♦','3♦','3♠','2♠','A♠','K♦','Q♦','J♦','10♦',
                        '10♠','9♠','8♠','7♠','6♠','5♠','4♠','K♠','Q♠','J♠'];

        const P = [37,34,17,42,24,7,4,5,43,27,10,47,30,0,14,51,21,18,1,38,8,22,6,44,41,11,48,31,32,15,12,35,
                   19,2,39,40,23,20,45,28,25,50,9,46,16,13,36,33,3,49,29,26];

        function generateSpread(yearNum) {
            let flat = [...YEAR_0];
            for (let i = 0; i < yearNum; i++) flat = P.map(idx => flat[idx]);
            return flat;
        }

        function getLeftPos(pos) {
            if (pos >= 49) return {51:50, 50:49, 49:49}[pos] || pos;
            let row = Math.floor(pos / 7);
            let col = pos % 7 - 1;
            if (col >= 0) return row * 7 + col;
            let newRow = row + 1;
            return newRow < 7 ? newRow * 7 + 6 : 51;
        }

        function extractSeven(flat, birthPos) {
            let current = birthPos;
            let cards = [];
            for (let i = 0; i < 7; i++) {
                current = getLeftPos(current);
                cards.push(flat[current]);
            }
            return cards.reverse();  // FIXED ORDER - now Mercury first, Neptune last
        }

        // Birth card via solar value formula (Olney Richmond, 1893)
        // solar_value = 55 - (month * 2 + day)
        function getBirthCard(birthStr) {
            const date = new Date(birthStr);
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const solarValue = 55 - (m * 2 + d);
            if (solarValue <= 0) return "Joker";
            const suits = ['♥', '♣', '♦', '♠'];
            const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const suit = suits[Math.floor((solarValue - 1) / 13)];
            const rank = ranks[(solarValue - 1) % 13];
            return `${rank}${suit}`;
        }

        function calculate(mode) {
            const birthStr = document.getElementById('birth').value;
            let targetStr = document.getElementById('target').value || new Date().toISOString().split('T')[0];

            if (!birthStr) return alert("Enter birth date");

            const birthCard = getBirthCard(birthStr);
            if (birthCard === "Joker") return alert("Joker - no reading");

            const birthDate = new Date(birthStr);
            const targetDate = new Date(targetStr);

            let spreadNum, activeCard, planetLabel, extraInfo, seven;

            if (mode === 'year') {
                let age = targetDate.getFullYear() - birthDate.getFullYear();
                if ((targetDate.getMonth() < birthDate.getMonth()) || 
                    (targetDate.getMonth() === birthDate.getMonth() && targetDate.getDate() < birthDate.getDate())) age--;
                spreadNum = (Math.max(age, 0) % 90) + 1;

                const flat = generateSpread(spreadNum);
                const birthPos = flat.indexOf(birthCard);
                seven = extractSeven(flat, birthPos);

                let thisYearBday = new Date(targetDate.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                if (thisYearBday > targetDate) {
                    thisYearBday = new Date(targetDate.getFullYear() - 1, birthDate.getMonth(), birthDate.getDate());
                }
                let daysSince = Math.floor((targetDate - thisYearBday) / 86400000) + 1;

                const period = Math.min(Math.floor((daysSince - 1) / 52), 6);
                activeCard = seven[period];
                planetLabel = ["Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune"][period];
                extraInfo = `${daysSince} days since birthday`;
            } else {
                const totalDays = Math.floor((targetDate - birthDate) / 86400000);
                const totalWeeks = Math.floor(totalDays / 7);
                spreadNum = (totalWeeks % 90) + 1;

                const flat = generateSpread(spreadNum);
                const birthPos = flat.indexOf(birthCard);
                seven = extractSeven(flat, birthPos);

                const dow = targetDate.getDay();
                const idx = [6,0,1,2,3,4,5][dow];
                activeCard = seven[idx];
                planetLabel = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][dow];
                extraInfo = `Week ${spreadNum}`;
            }

            document.getElementById('extracted').innerHTML = seven.join(" → ");

            document.getElementById('birth-card').innerHTML = birthCard;
            document.getElementById('active-card').innerHTML = activeCard;
            document.getElementById('spread-year').textContent = spreadNum;
            document.getElementById('planet-label').innerHTML = `${planetLabel} <span class="text-xs">(${extraInfo})</span>`;
            document.getElementById('realm-archetype').textContent = `${getSuitRealm(activeCard)} • ${getRankArchetype(activeCard)}`;

            const draft = `You're already doing that thing again.\n\nThe pattern is the ${getRankArchetype(activeCard)} in the ${getSuitRealm(activeCard).toLowerCase()} domain, activated through ${planetLabel.toLowerCase()} perception.\n\nThe uncomfortable line: this is costing you more than you're admitting.`;
            document.getElementById('draft').value = draft;

            document.getElementById('result-panel').classList.remove('hidden');
        }

        function getSuitRealm(card) {
            if (card.includes('♥')) return "Emotional";
            if (card.includes('♣')) return "Behavioral";
            if (card.includes('♦')) return "Material";
            return "Intellectual";
        }

        function getRankArchetype(card) {
            const r = card.replace(/[♥♣♦♠]/, '');
            const arch = {A:'Pioneer',2:'Partner',3:'Creator',4:'Builder',5:'Disruptor',6:'Server',7:'Seeker',8:'Commander',9:'Completer',10:'Master',J:'Messenger',Q:'Sovereign',K:'Authority'};
            return arch[r] || r;
        }

        function copyDraft() {
            const ta = document.getElementById('draft');
            ta.select();
            document.execCommand('copy');
            alert('Draft copied');
        }

        function postToX() {
            if (!window.currentReading) return;
            const text = encodeURIComponent(window.currentReading.text + `\n\n— Analog Algorithm • ${new Date(window.currentReading.date).toLocaleDateString()}\n#AnalogAlgorithm`);
            window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank');
        }

        window.onload = () => {
            document.getElementById('target').value = new Date().toISOString().split('T')[0];
        };
    </script>
</body>
</html>
